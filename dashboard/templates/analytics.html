{% extends "base.html" %}

{% block title %}Advanced Analytics - Financial Dashboard{% endblock %}

{% block content %}
<style>
    .analytics-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #ddd;
    }
    .analytics-tabs button {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    .analytics-tabs button.active {
        border-bottom-color: #007bff;
        color: #007bff;
        font-weight: bold;
    }
    .analytics-tabs button:hover {
        background: #f5f5f5;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .controls > div {
        flex: 1;
        min-width: 200px;
    }
    .controls label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .controls select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .checkbox-group h6 {
        margin-bottom: 10px;
        color: #666;
    }
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .chart-container {
        min-height: 500px;
        margin-bottom: 30px;
    }
    .hidden {
        display: none;
    }
</style>

<div class="analytics-container">
    <h1 style="margin-bottom: 30px;">
        <i class="fas fa-chart-line"></i> Advanced Analytics
    </h1>

    <!-- Tab Navigation -->
    <div class="analytics-tabs">
        <button class="tab-btn active" data-tab="sector">
            <i class="fas fa-industry"></i> Sector Analysis
        </button>
        <button class="tab-btn" data-tab="market">
            <i class="fas fa-globe"></i> Market Comparison
        </button>
        <button class="tab-btn" data-tab="correlation">
            <i class="fas fa-project-diagram"></i> Correlation Analysis
        </button>
        <button class="tab-btn" data-tab="crypto">
            <i class="fab fa-bitcoin"></i> Crypto Analysis
        </button>
    </div>

    <!-- Tab Panels -->
    <div class="tab-content active" data-tab-content="sector">
        <div class="controls">
            <div>
                <label for="sectorTimeRange">Time Range:</label>
                <select id="sectorTimeRange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            <div>
                <label for="sectorNormalize">View Mode:</label>
                <select id="sectorNormalize">
                    <option value="true" selected>Normalized (%)</option>
                    <option value="false">Absolute ($)</option>
                </select>
            </div>
            <div>
                <label for="sectorSelect">Explore Sector:</label>
                <select id="sectorSelect">
                    <option value="">Select a sector...</option>
                    {% for sector in sectors %}
                    <option value="{{ sector }}">{{ sector }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div id="sectorPerformanceChart" class="chart-container"></div>
        <div id="sectorStocksChart" class="chart-container hidden"></div>
    </div>

    <div class="tab-content" data-tab-content="market">
        <div class="controls">
            <div>
                <label for="marketTimeRange">Time Range:</label>
                <select id="marketTimeRange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            <div>
                <label for="marketNormalize">View Mode:</label>
                <select id="marketNormalize">
                    <option value="true" selected>Normalized (Base=100)</option>
                    <option value="false">Absolute ($)</option>
                </select>
            </div>
        </div>
        <h3>US vs European Markets</h3>
        <p style="color: #666;">Compare S&P 500, Dow Jones, DAX, Euro Stoxx 50, and FTSE 100</p>
        <div id="marketComparisonChart" class="chart-container"></div>
    </div>

    <div class="tab-content" data-tab-content="correlation">
        <div class="checkbox-grid">
            <div class="checkbox-group">
                <h6>US Indexes</h6>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^GSPC" id="gspc" checked>
                    <label for="gspc">S&P 500</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^DJI" id="dji" checked>
                    <label for="dji">Dow Jones</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^IXIC" id="ixic">
                    <label for="ixic">NASDAQ</label>
                </div>
            </div>
            <div class="checkbox-group">
                <h6>European Indexes</h6>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^GDAXI" id="gdaxi" checked>
                    <label for="gdaxi">DAX</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^STOXX50E" id="stoxx">
                    <label for="stoxx">Euro Stoxx 50</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="^FTSE" id="ftse">
                    <label for="ftse">FTSE 100</label>
                </div>
            </div>
            <div class="checkbox-group">
                <h6>Tech Stocks</h6>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="AAPL" id="aapl">
                    <label for="aapl">Apple</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="MSFT" id="msft">
                    <label for="msft">Microsoft</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="NVDA" id="nvda">
                    <label for="nvda">NVIDIA</label>
                </div>
            </div>
            <div class="checkbox-group">
                <h6>Chemicals</h6>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="BAS.DE" id="bas">
                    <label for="bas">BASF</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="DOW" id="dow">
                    <label for="dow">Dow Inc.</label>
                </div>
                <div class="checkbox-item">
                    <input class="correlation-ticker" type="checkbox" value="LIN.DE" id="lin">
                    <label for="lin">Linde</label>
                </div>
            </div>
        </div>
        <button class="btn" id="updateCorrelationBtn" style="margin-bottom: 20px;">
            <i class="fas fa-sync"></i> Update Correlation Matrix
        </button>
        <div id="correlationChart" class="chart-container"></div>
    </div>

    <div class="tab-content" data-tab-content="crypto">
        <h3>Cryptocurrency Correlation Analysis</h3>
        <p style="color: #666;">Correlation between major cryptocurrencies</p>
        <div id="cryptoCorrelationChart" class="chart-container"></div>
    </div>

</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update active button
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`[data-tab-content="${tabName}"]`).classList.add('active');
            
            // Load data for the tab
            switch(tabName) {
                case 'sector':
                    loadSectorPerformance();
                    break;
                case 'market':
                    loadMarketComparison();
                    break;
                case 'correlation':
                    loadCorrelationMatrix();
                    break;
                case 'crypto':
                    loadCryptoCorrelation();
                    break;
            }
        });
    });

    // Sector Performance
    function loadSectorPerformance() {
        const days = document.getElementById('sectorTimeRange').value;
        const normalize = document.getElementById('sectorNormalize').value;
        fetch(`/api/analytics/sector-performance?days=${days}&normalize=${normalize}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('sectorPerformanceChart').innerHTML = 
                        `<div class="card"><div class="card-body">${data.error}</div></div>`;
                    return;
                }
                const chart = JSON.parse(data.chart);
                Plotly.newPlot('sectorPerformanceChart', chart.data, chart.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('sectorPerformanceChart').innerHTML = 
                    `<div class="card"><div class="card-body">Error loading sector performance</div></div>`;
            });
    }

    // Sector Stocks Drill-down
    function loadSectorStocks(sector) {
        const days = document.getElementById('sectorTimeRange').value;
        const normalize = document.getElementById('sectorNormalize').value;
        fetch(`/api/analytics/sector-stocks/${encodeURIComponent(sector)}?days=${days}&normalize=${normalize}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('sectorStocksChart').innerHTML = 
                        `<div class="card"><div class="card-body">${data.error}</div></div>`;
                    return;
                }
                const chart = JSON.parse(data.chart);
                Plotly.newPlot('sectorStocksChart', chart.data, chart.layout, {responsive: true});
                document.getElementById('sectorStocksChart').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Market Comparison
    function loadMarketComparison() {
        const days = document.getElementById('marketTimeRange').value;
        const normalize = document.getElementById('marketNormalize').value;
        fetch(`/api/analytics/market-comparison?days=${days}&normalize=${normalize}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('marketComparisonChart').innerHTML = 
                        `<div class="card"><div class="card-body">${data.error}</div></div>`;
                    return;
                }
                const chart = JSON.parse(data.chart);
                Plotly.newPlot('marketComparisonChart', chart.data, chart.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('marketComparisonChart').innerHTML = 
                    `<div class="card"><div class="card-body">Error loading market comparison</div></div>`;
            });
    }

    // Correlation Matrix
    function loadCorrelationMatrix() {
        const selected = Array.from(document.querySelectorAll('.correlation-ticker:checked'))
            .map(cb => cb.value);
        
        if (selected.length < 3) {
            alert('Please select at least 3 assets for correlation analysis');
            return;
        }
        
        const params = selected.map(t => `tickers=${encodeURIComponent(t)}`).join('&');
        fetch(`/api/analytics/correlation-matrix?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('correlationChart').innerHTML = 
                        `<div class="card"><div class="card-body">${data.error}</div></div>`;
                    return;
                }
                const chart = JSON.parse(data.chart);
                Plotly.newPlot('correlationChart', chart.data, chart.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('correlationChart').innerHTML = 
                    `<div class="card"><div class="card-body">Error loading correlation matrix</div></div>`;
            });
    }

    // Crypto Correlation
    function loadCryptoCorrelation() {
        fetch('/api/analytics/crypto-correlation')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('cryptoCorrelationChart').innerHTML = 
                        `<div class="card"><div class="card-body">${data.error}</div></div>`;
                    return;
                }
                const chart = JSON.parse(data.chart);
                Plotly.newPlot('cryptoCorrelationChart', chart.data, chart.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('cryptoCorrelationChart').innerHTML = 
                    `<div class="card"><div class="card-body">Error loading crypto correlation</div></div>`;
            });
    }

    // Event Listeners
    document.getElementById('sectorTimeRange').addEventListener('change', loadSectorPerformance);
    document.getElementById('sectorNormalize').addEventListener('change', loadSectorPerformance);
    document.getElementById('sectorSelect').addEventListener('change', function() {
        if (this.value) {
            loadSectorStocks(this.value);
        } else {
            document.getElementById('sectorStocksChart').classList.add('hidden');
        }
    });
    document.getElementById('marketTimeRange').addEventListener('change', loadMarketComparison);
    document.getElementById('marketNormalize').addEventListener('change', loadMarketComparison);
    document.getElementById('updateCorrelationBtn').addEventListener('click', loadCorrelationMatrix);

    // Initial load
    loadSectorPerformance();
</script>
{% endblock %}
